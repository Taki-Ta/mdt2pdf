name: æ„å»ºDockeré•œåƒ

on:
    push:
        branches: [main, master]
        tags: ["v*.*.*"]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

env:
    IMAGE_NAME: mdt2pdf

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½®Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: æå–å…ƒæ•°æ®
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-

            - name: æ„å»ºDockeré•œåƒ
              uses: docker/build-push-action@v5
              with:
                  context: .
                  platforms: linux/amd64,linux/arm64
                  push: false
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  outputs: type=oci,dest=/tmp/mdt2pdf-image.tar
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: å‹ç¼©é•œåƒæ–‡ä»¶
              run: |
                  gzip /tmp/mdt2pdf-image.tar
                  ls -lh /tmp/mdt2pdf-image.tar.gz

            - name: ä¸Šä¼ é•œåƒäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: docker-image-${{ github.sha }}
                  path: /tmp/mdt2pdf-image.tar.gz
                  retention-days: 7

            - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
              if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
              run: |
                  echo "## Dockeré•œåƒæ„å»ºå®Œæˆ ğŸ³" > release_notes.md
                  echo "" >> release_notes.md
                  echo "### ä½¿ç”¨æ–¹æ³•" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "1. ä¸‹è½½é•œåƒæ–‡ä»¶ \`mdt2pdf-image.tar.gz\`" >> release_notes.md
                  echo "2. è§£å‹å¹¶åŠ è½½é•œåƒï¼š" >> release_notes.md
                  echo "   \`\`\`bash" >> release_notes.md
                  echo "   gunzip mdt2pdf-image.tar.gz" >> release_notes.md
                  echo "   docker load < mdt2pdf-image.tar" >> release_notes.md
                  echo "   \`\`\`" >> release_notes.md
                  echo "3. è¿è¡Œå®¹å™¨ï¼š" >> release_notes.md
                  echo "   \`\`\`bash" >> release_notes.md
                  echo "   docker run -p 8000:8000 ${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> release_notes.md
                  echo "   \`\`\`" >> release_notes.md
                  echo "4. è®¿é—®åº”ç”¨ï¼šhttp://localhost:8000" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "### è‡ªå®šä¹‰ç«¯å£" >> release_notes.md
                  echo "   \`\`\`bash" >> release_notes.md
                  echo "   docker run -p 3000:3000 -e PORT=3000 ${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> release_notes.md
                  echo "   \`\`\`" >> release_notes.md
                  echo "" >> release_notes.md
                  echo "### é•œåƒä¿¡æ¯" >> release_notes.md
                  echo "- **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
                  echo "- **æäº¤SHA**: ${{ github.sha }}" >> release_notes.md
                  echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> release_notes.md
                  echo "- **æ”¯æŒæ¶æ„**: linux/amd64, linux/arm64" >> release_notes.md

            - name: å‘å¸ƒåˆ°Releasesï¼ˆä»…æ ‡ç­¾æ¨é€ï¼‰
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: /tmp/mdt2pdf-image.tar.gz
                  body_path: release_notes.md
                  generate_release_notes: true

    test:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: ä¸‹è½½æ„å»ºçš„é•œåƒ
              uses: actions/download-artifact@v4
              with:
                  name: docker-image-${{ github.sha }}
                  path: /tmp

            - name: åŠ è½½å¹¶æµ‹è¯•é•œåƒ
              run: |
                  gunzip /tmp/mdt2pdf-image.tar.gz
                  docker load < /tmp/mdt2pdf-image.tar

                  # å¯åŠ¨å®¹å™¨
                  docker run -d -p 8000:8000 --name test-container ${{ env.IMAGE_NAME }}:${{ github.ref_name }}

                  # ç­‰å¾…æœåŠ¡å¯åŠ¨
                  sleep 10

                  # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
                  curl -f http://localhost:8000/health || exit 1

                  # æµ‹è¯•ä¸»é¡µ
                  curl -f http://localhost:8000/ || exit 1

                  # æ¸…ç†
                  docker stop test-container
                  docker rm test-container

                  echo "âœ… é•œåƒæµ‹è¯•é€šè¿‡ï¼"
